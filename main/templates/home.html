{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Главная</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Хедер с фоном -->
    <header class="header-section">
        <video class="header-video" id="mainVideo" autoplay muted loop playsinline>
            <source src="{% static 'images/mainback3.mp4' %}" type="video/mp4">
        </video>
        <!-- Внутри него фиксированный navbar -->
        <div class="navbar">
            <nav class="nav-container">
                <button class="mobile-toggle" aria-label="Открыть меню">☰</button>
                <!-- <button id="burger" class="burger" aria-label="Открыть меню">☰</button> -->
                 <div class="nav-tour__logo-block">
                    <a href="{% url 'home' %}">
                        <img src="/static/images/Lovi Moment logo.png" alt="Логотип" class="nav-tour__logo">
                    </a>
                </div>
                <ul class="nav-menu">
                    <li><a href="{% url 'about_us' %}">О нас</a></li>
                    <li class="nav-tour__item nav-tour__dropdown">
                        <a href="{% url 'tour' %}" class="nav-tour__link">Туры</a>
                        <ul class="nav-tour__submenu">
                            <li><a href="{% url 'tour' %}">Кыргызстан</a></li>
                            <li><a href="{% url 'kz' %}">Казахстан</a></li>
                            <li><a href="{% url 'uz' %}">Узбекистан</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'gallery' %}">Галерея</a></li>
                    <li><a href="{% url 'blog' %}">Блог</a></li>
                    <li><a href="{% url 'partners' %}">Партнерам</a></li>
                </ul>
                <div class="lang">
                    <a href="#">En</a>
                </div>
            </nav>
        </div>

        <!-- Контент в фоне -->
        <div class="header-content">
            <div class="header-stack">
                <!-- <img src="{% static 'images/' %}" alt="Первая картинка" class="stack-img"> -->
                <img id="lineUnder" src="{% static 'images/mainText.png' %}" alt="Вторая картинка" class="stack-img">
                <a href="{% url 'sign_tour' %}" style="text-decoration: none;">
                    <button class="text-button">
                        Записаться на тур!
                        <img src="/static/images/Arrow 1.png" alt="→" />
                    </button>
                </a>
                <a href="#form" class="img-button">
                    <img src="{% static 'images/Vector 9.svg' %}" alt="Вниз">
                </a>
            </div>
            
        </div>
    </header>

    <main>
        <section class="gallery-section">
            <!-- Первый ряд -->
            <div class="gallery-row first-row">
              <div class="gallery-track">
                <img src="{% static 'images/Rectangle 1.png' %}" alt="img1">
                <img src="{% static 'images/Rectangle 2.png' %}" alt="img2">
                <img src="{% static 'images/Rectangle 3.png' %}" alt="img3">
                <img src="{% static 'images/Rectangle 4.png' %}" alt="img4">
                <img src="{% static 'images/Rectangle 15.png' %}" alt="img5">
                <img src="{% static 'images/Rectangle 1.png' %}" alt="img1">
                <img src="{% static 'images/Rectangle 2.png' %}" alt="img2">
                <img src="{% static 'images/Rectangle 3.png' %}" alt="img3">
                <img src="{% static 'images/Rectangle 4.png' %}" alt="img4">
                <img src="{% static 'images/Rectangle 15.png' %}" alt="img5">
              </div>
            </div>
          
            <!-- Второй ряд -->
            <div class="gallery-row second-row">
              <div class="gallery-track">
                <img src="{% static 'images/Rectangle 14.png' %}" alt="img6">
                <img src="{% static 'images/Rectangle 12.png' %}" alt="img7">
                <img src="{% static 'images/Rectangle 13.png' %}" alt="img8">
                <img src="{% static 'images/Rectangle 14.png' %}" alt="img9">
                <img src="{% static 'images/Rectangle 15.png' %}" alt="img9">
                <img src="{% static 'images/Rectangle 14.png' %}" alt="img1">
                <img src="{% static 'images/Rectangle 12.png' %}" alt="img2">
                <img src="{% static 'images/Rectangle 13.png' %}" alt="img3">
                <img src="{% static 'images/Rectangle 14.png' %}" alt="img4">
                <img src="{% static 'images/Rectangle 15.png' %}" alt="img5">
              </div>
            </div>
        </section>
        <!-- HTML: Карусель секция -->
        <section class="tours-section">
            <h2 class="tours-title">Успей записаться <br> на предстоящие поездки!</h2>
            <div class="carousel-container">
                <div class="tochkiknopki">
                    <button class="carousel-arrow left" id="prevBtn">
                        <img src="/static/images/lfArr.png" alt="←" style="background-color: #fff; border-radius: 50px;">
                    </button>
                    <div class="carousel-track" id="carouselTrack">
                        <div class="tour-card" style="background-image: url('/static/images/Rectangle 19.png')">
                            <div class="tour-title">Тур в горы</div>
                            <div class="tour-dates">
                                <div><span>12</span><small>июля</small></div>
                                <div><span>18</span><small>авг</small></div>
                                <div><span>02</span><small>сент</small></div>
                            </div>
                            <a href="{% url 'tour' %}" style="text-decoration: none;">
                                <button class="tour-btn">
                                    Записаться на тур!
                                    <img src="/static/images/Vector 11.png" alt="→" />
                                </button>
                            </a>
                        </div>
                        <div class="tour-card" style="background-image: url('/static/images/ysyk9.jpg')">
                            <div class="tour-title">Морской отдых</div>
                            <div class="tour-dates">
                                <div><span>05</span><small>июля</small></div>
                                <div><span>14</span><small>авг</small></div>
                                <div><span>25</span><small>сент</small></div>
                            </div>
                            <a href="{% url 'tour' %}" style="text-decoration: none;">
                                <button class="tour-btn">
                                    Записаться на тур!
                                    <img src="/static/images/Vector 11.png" alt="→" />
                                </button>
                            </a>
                        </div>
                        <div class="tour-card" style="background-image: url('/static/images/altyn3.jpg')">
                            <div class="tour-title">Поход по ущелью</div>
                            <div class="tour-dates">
                                <div><span>20</span><small>июля</small></div>
                                <div><span>28</span><small>авг</small></div>
                                <div><span>10</span><small>сент</small></div>
                            </div>
                            <a href="{% url 'tour' %}" style="text-decoration: none;">
                                <button class="tour-btn">
                                    Записаться на тур!
                                    <img src="/static/images/Vector 11.png" alt="→" />
                                </button>
                            </a>
                        </div> 
                        <div class="tour-card" id="last-tour-card" style="background-image: url('/static/images/ysyk3.jpg')">
                            <div class="tour-title">Поход на озеро</div>
                            <div class="tour-dates">
                                <div><span>20</span><small>июля</small></div>
                                <div><span>28</span><small>авг</small></div>
                                <div><span>10</span><small>сент</small></div>
                            </div>
                            <a href="{% url 'tour' %}" style="text-decoration: none;">
                                <button class="tour-btn">
                                    Записаться на тур!
                                    <img src="/static/images/Vector 11.png" alt="→" />
                                </button>
                            </a>
                        </div>
                        <!-- правая стрелка -->
                        <button class="carousel-arrow right" id="nextBtn">
                            <img src="/static/images/rrArr.png" alt="→" style="background-color: #fff; border-radius: 50px;">
                        </button>
                        <div class="carousel-dots" id="carouselDots">
                            <span class="dot current-dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                </div>
            </div>
            <h2>Или</h2>
            <div class="stan">
                <h2>Выбери свою поездку!</h2>
                <div class="cards-stan">
                    <div class="cardstan">
                        <img src="/static/images/kg.png" alt="Фото страны" />
                        <h3>Кыргызстан</h3>
                        <button><a href="{% url 'tour' %}">Подробнее</a></button>
                        
                    </div>
                    <div class="cardstan">
                        <img src="/static/images/uz.png" alt="Фото страны" />
                        <h3>Узбекистан</h3>
                        <button><a href="{% url 'uz' %}">Подробнее</a></button>
                    </div>
                    <div class="cardstan">
                        <img src="/static/images/kz.png" alt="Фото страны" />
                        <h3>Казахстан</h3>
                        <button><a href="{% url 'kz' %}">Подробнее</a></button>
                    </div>
                </div>
            </div>
        </section>
        <section class="whyUs">
            <div class="whyUs-container">
                <div class="whyUs-left">
                    <img src="/static/images/wu12.png" alt="Фото Кыргызстана" />
                </div>
                <div class="whyUs-right">
                    <h2>Почему стоит выбрать Lovi Moment?</h2>
                    <p>
                        Мы — ваша дверь в удивительный мир Кыргызстана и Центральной Азии! <br> <br> Наша туристическая компания предлагает уникальные туры, которые позволят вам исследовать захватывающие пейзажи и богатую культуру этого региона. От величественных гор Тянь-Шаня до древних городов, таких как Самарканд и Бухара, мы обеспечим вам незабываемые впечатления. <br> <br>Наши опытные гиды помогут вам погрузиться в местные традиции и обычаи, делая каждое путешествие особенным. Присоединяйтесь к нам и откройте для себя тайны Кыргызстана и Центральной Азии!
                    </p>
                </div>
            </div>
        </section>

        <section class="stats-section">
            <div class="stats-row">
                <div class="stat-item">
                    <img src="{% static 'images/van.png' %}" alt="Тур" class="stat-icon">
                    <div class="stat-number">140</div>
                    <div class="stat-label">Организованных туров</div>
                </div>

                <div class="stat-item">
                    <img src="{% static 'images/happy.png' %}" alt="Туристы" class="stat-icon">
                    <div class="stat-number">16 500+</div>
                    <div class="stat-label">Довольных туристов</div>
                </div>

                <div class="stat-item">
                    <img src="{% static 'images/hands.png' %}" alt="Опыт" class="stat-icon">
                    <div class="stat-number">5 лет</div>
                    <div class="stat-label">Опыта</div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <img id="map" src="{% static 'images/map.png' %}" alt="Маршруты" class="stat-icon">
                    <div class="stat-number">15+</div>
                    <div class="stat-label">Уникальных маршрутов</div>
                </div>

                <div class="stat-item">
                    <img src="{% static 'images/camp.png' %}" alt="Виды туров" class="stat-icon">
                    <div class="stat-number">10</div>
                    <div class="stat-label">
                        Видов туров<br>
                        <small>треккинги, фото-туры,<br> корпоративные и т.д.</small>
                    </div>
                </div>
            </div>
        </section>

        <section class="ourTeam">
            <div class="ourTeam-container">
                <div class="ourTeam-right">
                    <h2>Наша команда</h2>
                    <p>
                        Наша команда состоит из опытных профессионалов, увлеченных путешествиями и культурой Центральной Азии. Каждый из нас имеет уникальный опыт и знания, которые помогают создавать незабываемые туры для наших клиентов. Мы гордимся тем, что можем делиться своей страстью к этому удивительному региону и обеспечивать высокий уровень сервиса. Присоединяйтесь к нам, и мы сделаем ваше путешествие по Кыргызстану и его окрестностям поистине незабываемым!
                    </p>
                </div>
                <div class="ourTeam-left">
                    <img src="/static/images/ot1.png" alt="Фото Кыргызстана" />
                </div>
            </div>
        </section>
        <section class="previews">
            <div class="reviews-header-two">
                <h2>Отзывы клиентов</h2>
                <button type="button" onclick="window.location.href='/reviews/'">Смотреть отзывы</button>
            </div>
        </section>
        <section class="application-section" id="form">
            <div class="application-image"></div>
            <div class="application-form">
                <div class="form-inner">
                <h2>Оставьте заявку уже <span class="highlight">сейчас!</span></h2>

                <form id="applicationForm" action="{% url 'submit_application' %}" method="post">
                    {% csrf_token %}
                    <input type="text" name="name" placeholder="ФИО" required>
                    <input type="tel" name="phone" placeholder="Номер телефона" required>

                    <div class="email-block">
                    <input type="email" name="email" placeholder="E-mail">
                    <small class="optional">Необязательно</small>
                    </div>

                    <label class="consent">
                    <input type="checkbox" name="consent" required>
                    Я даю согласие на обработку
                    <a href="#">персональных данных</a>
                    в соответствии с
                    <a href="#">политикой обработки</a>
                    </label>

                    <button type="submit" class="submit-btn">
                    Записаться на тур!
                    </button>

                    <p class="phone-alt">
                    Или позвоните по номеру<br>
                    <span>
                        +996 503 904 904 <br>
                            +996 705 904 904 <br>
                            +996 508 904 904 <br>
                            +996 505 904 904
                    </span>
                    </p>
                </form>
                </div>
            </div>
        </section>
        <footer class="footer">
            <div class="footer-inner">
                <div class="footer-col logo-col">
                    <img src="{% static 'images/Lovi Moment logo-1.png' %}" alt="Lovi Moment Travel" class="footer-logo" />
                </div>

                <div class="footer-col">
                    <h4>Главная</h4>
                    <ul>
                        <li><a href="{% url 'about_us' %}">О нас</a></li>
                        <li><a href="{% url 'blog' %}">Блог о Кыргызстане</a></li>
                        <li><a href="{% url 'corp_tour' %}">Корпоративные туры</a></li>
                        <li><a href="{% url 'indi_tour' %}">Индивидуальные туры</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                <h4>Туры</h4>
                    <ul>
                        <li><a href="{% url 'tour' %}">Кыргызстан</a></li>
                        <li><a href="{% url 'kz' %}">Казахстан</a></li>
                        <li><a href="{% url 'uz' %}">Узбекистан</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>По другим вопросам</h4>
                    <p>+996 503 904 904 </p>
                    <p>+996 705 904 904 </p>
                    <p>+996 508 904 904 </p>
                    <p>+996 505 904 904 </p>
                    <button class="footer-btn"><a href="{% url 'sign_tour' %}">Записаться на тур!</a></button>
                </div>

                <div class="footer-col address">
                    <h4>Адрес</h4>
                    <p>ул. Калык Акиева 66,<br> ТЦ Весна, 3 этаж  С13А</p>
                    <p><a  class="wattspp" href="https://wa.me/996505904904"><img src="/static/images/free-icon-logo-15713434.png" alt="" style="width: 32px; height: 32px;">996 505 904 904</a></p>
                    <p ><a class="instS" href="https://www.instagram.com/lovimoment_travel/"><img src="" alt=""><img src="/static/images/inst.png" alt="">@lovimoment_travel</a></p>
                </div>
            </div>
        </footer>
    </main>
</body>
<script>
// видео
    // const video = document.getElementById('headerVideo');
    // const stopTime = 4; // секунда, на которой нужно остановить

    // // Проверяем каждые 100 мс текущее время
    // const checker = setInterval(() => {
    //     if (video.currentTime >= stopTime) {
    //     video.pause();
    //     video.currentTime = stopTime; // зафиксировать на кадре
    //     clearInterval(checker); // выключить таймер
    //     }
    // }, 100);

/////////////////////////////////////////
//     const track = document.getElementById('carouselTrack');

//     // При прокрутке колёсиком — двигаем scrollLeft
//     track.addEventListener('wheel', (e) => {
//         e.preventDefault();                    // чтобы не скроллилась страница
//         track.scrollLeft += e.deltaY * 1.5;    // 1.5 — скорость, можно подкорректировать
//   });
//   ====================================================
// Загрузка видео главной страницы
async function loadMainVideo() {
  try {
    // Добавляем уникальный timestamp для обхода кеша API
    const apiUrl = '/api/main-video?t=' + Date.now() + '&r=' + Math.random();
    const response = await fetch(apiUrl, { cache: 'no-store' });
    const data = await response.json();
    const videoElement = document.getElementById('mainVideo');
    
    if (!videoElement) {
      console.error('Видео элемент не найден!');
      return;
    }
    
    if (!data || !data.videoPath) {
      console.warn('Путь к видео не получен из API:', data);
      return;
    }
    
    // Добавляем уникальный timestamp к URL видео для обхода кеша браузера
    const timestamp = Date.now();
    const videoUrl = data.videoPath + (data.videoPath.includes('?') ? '&' : '?') + 't=' + timestamp + '&r=' + Math.random();
    
    console.log('=== Загрузка видео ===');
    console.log('Путь из БД:', data.videoPath);
    console.log('Полный URL:', videoUrl);
    
    // Получаем базовый путь без параметров для сравнения
    const basePath = data.videoPath.split('?')[0];
    const currentSource = videoElement.querySelector('source');
    const currentSrc = currentSource ? currentSource.getAttribute('src') || currentSource.src : '';
    const currentBasePath = currentSrc ? currentSrc.split('?')[0] : '';
    
    console.log('Текущий базовый путь:', currentBasePath);
    console.log('Новый базовый путь:', basePath);
    
    // ВСЕГДА обновляем видео, если путь изменился или если это первая загрузка
    if (currentBasePath !== basePath || !currentBasePath) {
      console.log('Обновляю видео:', currentBasePath || '(нет)', '->', basePath);
      
      // Сохраняем родительский элемент и его атрибуты
      const parent = videoElement.parentElement;
      const className = videoElement.className;
      const id = videoElement.id;
      const style = videoElement.getAttribute('style');
      
      // Полностью удаляем старый video элемент
      videoElement.remove();
      
      // Создаем новый video элемент с нуля
      const newVideo = document.createElement('video');
      newVideo.id = id;
      newVideo.className = className;
      if (style) newVideo.setAttribute('style', style);
      newVideo.loop = true;
      newVideo.autoplay = true;
      newVideo.muted = true;
      newVideo.playsInline = true;
      newVideo.preload = 'auto';
      
      // Создаем новый source элемент
      const newSource = document.createElement('source');
      newSource.src = videoUrl;
      newSource.type = 'video/mp4';
      newVideo.appendChild(newSource);
      
      // Вставляем новый video элемент на место старого
      parent.appendChild(newVideo);
      
      console.log('Новый video элемент создан и вставлен');
      
      // Пытаемся воспроизвести после загрузки
      const playVideo = () => {
        console.log('Попытка воспроизвести видео');
        newVideo.play().catch(err => {
          console.log('Автовоспроизведение заблокировано браузером:', err);
        });
      };
      
      newVideo.addEventListener('loadeddata', () => {
        console.log('Видео загружено (loadeddata)');
        playVideo();
      }, { once: true });
      
      newVideo.addEventListener('canplay', () => {
        console.log('Видео готово к воспроизведению (canplay)');
        playVideo();
      }, { once: true });
      
      newVideo.addEventListener('canplaythrough', () => {
        console.log('Видео готово к воспроизведению полностью (canplaythrough)');
        playVideo();
      }, { once: true });
      
      newVideo.addEventListener('loadedmetadata', () => {
        console.log('Метаданные видео загружены (loadedmetadata)');
      }, { once: true });
      
      newVideo.addEventListener('error', (e) => {
        console.error('Ошибка загрузки видео:', e);
        console.error('Видео элемент:', newVideo);
        console.error('Source:', newSource);
        console.error('URL:', videoUrl);
        console.error('Код ошибки:', newVideo.error ? newVideo.error.code : 'неизвестно');
        console.error('Сообщение об ошибке:', newVideo.error ? newVideo.error.message : 'неизвестно');
      }, { once: true });
      
      // Принудительно загружаем видео
      newVideo.load();
      
      // Также пытаемся воспроизвести через небольшую задержку
      setTimeout(playVideo, 500);
      setTimeout(playVideo, 1000);
      setTimeout(playVideo, 2000);
    } else {
      console.log('Путь видео не изменился, обновляю только timestamp для обхода кеша');
      // Если путь тот же, просто обновляем timestamp для обхода кеша
      if (currentSource) {
        currentSource.src = videoUrl;
        videoElement.load();
      }
    }
  } catch (error) {
    console.error('Ошибка при загрузке видео:', error);
    // Используем видео по умолчанию, если API недоступен
  }
}

// Загрузка изображений галереи для главной страницы
async function loadHomeGallery() {
  try {
    const response = await fetch('/api/gallery');
    const images = await response.json();
    
    const firstRowTrack = document.querySelector('.gallery-section .first-row .gallery-track');
    const secondRowTrack = document.querySelector('.gallery-section .second-row .gallery-track');
    
    if (!firstRowTrack || !secondRowTrack) {
      console.warn('Элементы галереи не найдены');
      return;
    }
    
    if (!images || images.length === 0) {
      // Если нет изображений из API, оставляем статические
      console.log('Нет изображений из API, используем статические');
      return;
    }
    
    // Очищаем существующие изображения
    firstRowTrack.innerHTML = '';
    secondRowTrack.innerHTML = '';
    
    // Распределяем изображения между двумя рядами
    // Берем первые изображения для первого ряда, остальные для второго
    const firstRowImages = images.slice(0, Math.ceil(images.length / 2));
    const secondRowImages = images.slice(Math.ceil(images.length / 2));
    
    // Функция для добавления изображений в ряд (с дублированием для бесконечной прокрутки)
    const addImagesToRow = (track, imageList) => {
      // Добавляем изображения дважды для бесконечной прокрутки
      [...imageList, ...imageList].forEach((img, index) => {
        const imgEl = document.createElement('img');
        imgEl.src = img.imagePath;
        imgEl.alt = img.title || `Фотография ${index + 1}`;
        track.appendChild(imgEl);
      });
    };
    
    // Если изображений мало, используем все для обоих рядов
    if (images.length < 5) {
      addImagesToRow(firstRowTrack, images);
      addImagesToRow(secondRowTrack, images);
    } else {
      addImagesToRow(firstRowTrack, firstRowImages);
      addImagesToRow(secondRowTrack, secondRowImages);
    }
    
    console.log('Галерея загружена:', images.length, 'изображений');
  } catch (error) {
    console.error('Ошибка при загрузке галереи:', error);
    // В случае ошибки оставляем статические изображения
  }
}

// Загрузка видов туров для карусели
async function loadTourTypes() {
  console.log('=== Загрузка видов туров ===');
  try {
    const response = await fetch('/api/tour-types');
    const tourTypes = await response.json();
    console.log('Получено видов туров из API:', tourTypes.length);
    
    const track = document.getElementById('carouselTrack');
    const dotsNav = document.getElementById('carouselDots');
    
    console.log('Элементы карусели:', { track, dotsNav });
    
    if (!track || !dotsNav) {
      console.warn('Элементы карусели не найдены, пытаемся инициализировать со статическими карточками');
      // Пытаемся инициализировать карусель со статическими карточками
      setTimeout(() => {
        initCarousel();
      }, 100);
      return;
    }
    
    if (!tourTypes || tourTypes.length === 0) {
      // Если нет видов туров из API, оставляем статические
      console.log('Нет видов туров из API, используем статические карточки');
      // Инициализируем карусель со статическими карточками
      setTimeout(() => {
        initCarousel();
      }, 100);
      return;
    }
    
    // Очищаем существующие карточки и точки
    track.innerHTML = '';
    dotsNav.innerHTML = '';
    
    // Функция для форматирования даты
    const formatDate = (dateStr) => {
      if (!dateStr) return { day: '', month: '' };
      try {
        // Пробуем разные форматы даты
        let date;
        if (typeof dateStr === 'string') {
          // Если это строка, пробуем распарсить
          date = new Date(dateStr);
          // Проверяем, что дата валидна
          if (isNaN(date.getTime())) {
            // Пробуем другой формат: "DD.MM.YYYY" или "YYYY-MM-DD"
            const parts = dateStr.split(/[.\-\/]/);
            if (parts.length === 3) {
              // Если формат DD.MM.YYYY
              if (parts[0].length === 2 && parts[1].length === 2) {
                date = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
              } else {
                // Если формат YYYY-MM-DD
                date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
              }
            } else {
              return { day: '', month: '' };
            }
          }
        } else if (dateStr instanceof Date) {
          date = dateStr;
        } else {
          return { day: '', month: '' };
        }
        
        // Проверяем, что дата валидна
        if (isNaN(date.getTime())) {
          console.warn('Невалидная дата:', dateStr);
          return { day: '', month: '' };
        }
        
        const months = ['янв', 'фев', 'мар', 'апр', 'мая', 'июня', 'июля', 'авг', 'сент', 'окт', 'ноя', 'дек'];
        return {
          day: date.getDate().toString(),
          month: months[date.getMonth()]
        };
      } catch (e) {
        console.error('Ошибка при форматировании даты:', dateStr, e);
        return { day: '', month: '' };
      }
    };
    
    // Создаем карточки для каждого вида тура
    tourTypes.forEach((tourType, index) => {
      // Создаем карточку тура
      const card = document.createElement('div');
      card.className = 'tour-card';
      if (index === tourTypes.length - 1) {
        card.id = 'last-tour-card';
      }
      
      // Устанавливаем фоновое изображение
      const imagePath = tourType.imagePath || '/static/images/Rectangle 19.png';
      card.style.backgroundImage = `url('${imagePath}')`;
      
      // Заголовок
      const title = document.createElement('div');
      title.className = 'tour-title';
      title.textContent = tourType.name || 'Тур';
      card.appendChild(title);
      
      // Даты
      const datesDiv = document.createElement('div');
      datesDiv.className = 'tour-dates';
      
      // Обрабатываем даты из JSON поля dates
      // В админ-панели даты сохраняются как массив чисел (1-31) - дни месяца
      let dayNumbers = [];
      if (tourType.dates) {
        if (typeof tourType.dates === 'string') {
          try {
            dayNumbers = JSON.parse(tourType.dates);
          } catch (e) {
            dayNumbers = [];
          }
        } else if (Array.isArray(tourType.dates)) {
          dayNumbers = tourType.dates;
        }
      }
      
      // Если дат нет, используем дефолтные числа месяца
      if (dayNumbers.length === 0) {
        dayNumbers = [12, 18, 2];
      }
      
      // Преобразуем числа месяца в ближайшие будущие даты
      const now = new Date();
      const currentDay = now.getDate();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      const months = ['янв', 'фев', 'мар', 'апр', 'мая', 'июня', 'июля', 'авг', 'сент', 'окт', 'ноя', 'дек'];
      
      // Создаем массив всех возможных дат (текущий месяц и следующие 12 месяцев)
      const allDates = [];
      for (let monthOffset = 0; monthOffset < 12; monthOffset++) {
        dayNumbers.forEach(dayNum => {
          const date = new Date(currentYear, currentMonth + monthOffset, parseInt(dayNum));
          // Проверяем, что дата валидна и не в прошлом
          if (!isNaN(date.getTime()) && date.getDate() === parseInt(dayNum)) {
            // Если это текущий месяц, проверяем, что дата еще не прошла
            if (monthOffset === 0 && parseInt(dayNum) < currentDay) {
              // Пропускаем прошедшие даты текущего месяца
              return;
            }
            allDates.push({
              day: parseInt(dayNum),
              month: date.getMonth(),
              year: date.getFullYear(),
              date: date
            });
          }
        });
      }
      
      // Сортируем по дате и берем первые 3 ближайшие будущие даты
      allDates.sort((a, b) => a.date - b.date);
      const nearestDates = allDates.slice(0, 3);
      
      // Отображаем даты
      nearestDates.forEach(dateInfo => {
        const monthName = months[dateInfo.month];
        const dateItem = document.createElement('div');
        dateItem.innerHTML = `<span>${dateInfo.day}</span><small>${monthName}</small>`;
        datesDiv.appendChild(dateItem);
      });
      
      // Если не добавилось ни одной даты, добавляем дефолтные
      if (datesDiv.children.length === 0) {
        const defaultDates = [
          { day: '12', month: 'июля' },
          { day: '18', month: 'авг' },
          { day: '02', month: 'сент' }
        ];
        defaultDates.forEach(d => {
          const dateItem = document.createElement('div');
          dateItem.innerHTML = `<span>${d.day}</span><small>${d.month}</small>`;
          datesDiv.appendChild(dateItem);
        });
      }
      
      card.appendChild(datesDiv);
      
      // Кнопка
      const link = document.createElement('a');
      link.href = '/tour/';
      link.style.textDecoration = 'none';
      
      const button = document.createElement('button');
      button.className = 'tour-btn';
      button.innerHTML = 'Записаться на тур! <img src="/static/images/Vector 11.png" alt="→" />';
      link.appendChild(button);
      card.appendChild(link);
      
      track.appendChild(card);
      
      // Создаем точку для навигации
      const dot = document.createElement('div');
      dot.className = 'dot';
      if (index === 0) {
        dot.classList.add('current-dot');
      }
      dotsNav.appendChild(dot);
    });
    
    console.log('Виды туров загружены:', tourTypes.length, 'карточек');
    
    // Инициализируем карусель после загрузки (с небольшой задержкой для рендеринга DOM)
    setTimeout(() => {
      console.log('Вызов initCarousel() после загрузки туров');
      initCarousel();
    }, 100);
  } catch (error) {
    console.error('Ошибка при загрузке видов туров:', error);
    // В случае ошибки оставляем статические карточки
    setTimeout(() => {
      console.log('Вызов initCarousel() после ошибки');
      initCarousel();
    }, 100);
  }
}

// Инициализация карусели
function initCarousel() {
  const track = document.getElementById('carouselTrack');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const dotsNav = document.getElementById('carouselDots');
  
  if (!track || !prevBtn || !nextBtn || !dotsNav) {
    return;
  }
  
  const cards = Array.from(track.querySelectorAll('.tour-card'));
  const dots = Array.from(dotsNav.querySelectorAll('.dot'));
  let currentIndex = 0;
  let autoPlayInterval = null;
  
  if (cards.length === 0) {
    return;
  }
  
  function scrollToIndex(index) {
    const card = cards[index];
    const trackWidth = track.clientWidth;
    const cardWidth = card.offsetWidth;
    const cardOffset = card.offsetLeft;
    
    // хотим центрировать:
    let scrollLeft = cardOffset - (trackWidth - cardWidth) / 2;
    
    // clamp: не выходить за границы
    const maxScroll = track.scrollWidth - trackWidth;
    scrollLeft = Math.max(0, Math.min(scrollLeft, maxScroll));
    
    track.scrollTo({ left: scrollLeft, behavior: 'smooth' });
    
    // обновляем вид стрелок и точек
    updateButtons();
    updateDots();
  }
  
  function updateButtons() {
    prevBtn.style.visibility = (currentIndex === 0) ? 'hidden' : 'visible';
    nextBtn.style.visibility = (currentIndex === cards.length - 1) ? 'hidden' : 'visible';
  }
  
  function updateDots() {
    dots.forEach(dot => dot.classList.remove('current-dot'));
    if (dots[currentIndex]) {
      dots[currentIndex].classList.add('current-dot');
    }
  }
  
  // Функция для автоматического переключения
  function startAutoPlay() {
    // Останавливаем предыдущий интервал, если он есть
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
      console.log('Остановлен предыдущий интервал автопереключения');
    }
    
    console.log('Запуск автоматического переключения карусели');
    
    // Запускаем автоматическое переключение каждые 4 секунды
    autoPlayInterval = setInterval(() => {
      // Переключаем на следующий тур
      if (currentIndex < cards.length - 1) {
        currentIndex++;
      } else {
        // Если достигли конца, возвращаемся к началу
        currentIndex = 0;
      }
      console.log('Автоматическое переключение на индекс:', currentIndex, 'из', cards.length - 1);
      scrollToIndex(currentIndex);
    }, 4000); // 4 секунды
  }
  
  // Функция для остановки автоматического переключения
  function stopAutoPlay() {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
      autoPlayInterval = null;
    }
  }
  
  // Функция для перезапуска автоматического переключения
  function restartAutoPlay() {
    stopAutoPlay();
    // Перезапускаем через 4 секунды после ручного управления
    setTimeout(() => {
      startAutoPlay();
    }, 4000);
  }
  
  // клики по стрелкам
  prevBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('Клик по кнопке "Назад", текущий индекс:', currentIndex);
    if (currentIndex > 0) {
      currentIndex--;
      console.log('Переключение на индекс:', currentIndex);
      scrollToIndex(currentIndex);
      restartAutoPlay(); // Перезапускаем автоматическое переключение
    } else {
      console.log('Уже на первом элементе');
    }
  });
  
  nextBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('Клик по кнопке "Вперед", текущий индекс:', currentIndex);
    if (currentIndex < cards.length - 1) {
      currentIndex++;
      console.log('Переключение на индекс:', currentIndex);
      scrollToIndex(currentIndex);
      restartAutoPlay(); // Перезапускаем автоматическое переключение
    } else {
      console.log('Уже на последнем элементе');
    }
  });
  
  // клики по точкам
  dotsNav.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const i = dots.indexOf(e.target);
    console.log('Клик по точкам, индекс кликнутой точки:', i, 'текущий индекс:', currentIndex);
    if (i !== -1) {
      console.log('Переключение на индекс:', i);
      currentIndex = i;
      scrollToIndex(currentIndex);
      restartAutoPlay(); // Перезапускаем автоматическое переключение
    }
  });
  
  // Останавливаем автоматическое переключение при наведении на карусель
  track.addEventListener('mouseenter', stopAutoPlay);
  track.addEventListener('mouseleave', startAutoPlay);
  
  // Останавливаем автоматическое переключение при наведении на стрелки
  prevBtn.addEventListener('mouseenter', stopAutoPlay);
  nextBtn.addEventListener('mouseenter', stopAutoPlay);
  prevBtn.addEventListener('mouseleave', startAutoPlay);
  nextBtn.addEventListener('mouseleave', startAutoPlay);
  
  // первая инициализация
  console.log('Первая инициализация, прокрутка к индексу 0');
  scrollToIndex(0);
  
  // Запускаем автоматическое переключение
  console.log('Запуск автопереключения');
  startAutoPlay();
  
  console.log('=== Инициализация карусели завершена ===');
}

document.addEventListener('DOMContentLoaded', () => {
  // Загружаем видео главной страницы
  loadMainVideo();
  
  // Загружаем галерею
  loadHomeGallery();
  
  // Загружаем виды туров (эта функция сама вызовет initCarousel после загрузки)
  loadTourTypes();
  
  // Периодически проверяем обновление видео (каждые 30 секунд)
  // Это нужно, если видео было обновлено через админ-панель, пока страница открыта
  setInterval(() => {
    loadMainVideo();
  }, 30000); // Проверяем каждые 30 секунд
});

    // для бургера
    
    document.addEventListener('DOMContentLoaded', function() {
      const btn  = document.querySelector('.mobile-toggle');
      const menu = document.querySelector('.nav-menu');

      if (!btn || !menu) {
        console.error('Не нашёл .mobile-toggle или .nav-menu:', btn, menu);
        return;
      }

      btn.addEventListener('click', function() {
        menu.classList.toggle('open');
      });
    });

//     const burger = document.querySelector('.mobile-toggle');
//     const menu   = document.querySelector('.nav-menu');
//     burger.addEventListener('click', () => {
//         menu.classList.toggle('open');
//   });

//   ==========================================
    // document.addEventListener('DOMContentLoaded', function () {
    // const cards = document.querySelectorAll('.tour-card');
    // const prevBtn = document.getElementById('prevBtn');
    // const nextBtn = document.getElementById('nextBtn');
    // const dots = document.querySelectorAll('.carousel-dots .dot');

    // let currentIndex = 0;
    // const cardWidth = cards[0].offsetWidth + 30;

    // function updateCarousel() {
    //     cards.forEach((card, index) => {
    //     const offset = (index - currentIndex) * cardWidth;
    //     card.style.transform = `translateX(${offset}px)`;
    //     });

    //     dots.forEach((dot, index) => {
    //     dot.classList.toggle('active', index === currentIndex);
    //     });

    //     prevBtn.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';
    //     nextBtn.style.visibility = currentIndex === cards.length - 1 ? 'hidden' : 'visible';
    // }

    // prevBtn.addEventListener('click', () => {
    //     if (currentIndex > 0) {
    //     currentIndex--;
    //     updateCarousel();
    //     }
    // });

    // nextBtn.addEventListener('click', () => {
    //     if (currentIndex < cards.length - 1) {
    //     currentIndex++;
    //     updateCarousel();
    //     }
    // });

    // dots.forEach((dot, index) => {
    //     dot.addEventListener('click', () => {
    //     currentIndex = index;
    //     updateCarousel();
    //     });
    // });

    // updateCarousel();
    // });

    // скрол по Y для отзывов

    // const reviewsList = document.querySelector('.reviews-list');

    // reviewsList.addEventListener('wheel', function(e) {
    // // Отменяем стандартное вертикальное поведение прокрутки
    // e.preventDefault();
    // // Скроллим горизонтально на величину вертикального скролла
    // reviewsList.scrollLeft += e.deltaY;
    // });

document.addEventListener('DOMContentLoaded', () => {
  const track     = document.getElementById('reviewsList');
  const prevBtn   = document.getElementById('prevReview');
  const nextBtn   = document.getElementById('nextReview');
  
  // Проверяем существование элементов перед использованием
  if (!track || !prevBtn || !nextBtn) {
    return; // Выходим, если элементы не найдены
  }
  
  const cards     = Array.from(track.querySelectorAll('.review-card'));
  
  // Проверяем, что есть карточки
  if (cards.length === 0) {
    return; // Выходим, если нет карточек
  }
  
  const cardWidth = cards[0].offsetWidth;
  const gap       = parseInt(getComputedStyle(track).gap) || 0;
  const step      = cardWidth + gap;

  prevBtn.addEventListener('click', () => {
    track.scrollBy({ left: -step, behavior: 'smooth' });
  });
  nextBtn.addEventListener('click', () => {
    track.scrollBy({ left: step, behavior: 'smooth' });
  });
});
 // форма ============================================================
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('applicationForm');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const data = new FormData(form);

    fetch(form.action, {
      method: form.method,
      body: data,
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(json => {
      if (json.status === 'ok') {
        alert('Вы записались на тур');
        form.reset();
      } else {
        alert('Ошибка: ' + (json.error || 'неизвестная'));
      }
    })
    .catch(() => {
      alert('Не удалось отправить заявку. Попробуйте позже.');
    });
  });
});
// орнамент анимация
//  (function(){
//     const speed = 0.25; // скорость движения узора; 0.15–0.35 — комфортно
//     function onScroll(){
//       const y = Math.round(window.scrollY * speed);
//       document.documentElement.style.setProperty('--ornament-shift', `-${y}px`);
//     }
//     window.addEventListener('scroll', onScroll, {passive:true});
//     onScroll();
//   })();




</script>
</html>
