{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Туры</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header class="tour-header">
        <nav class="nav-tour">
            <!-- 1. Бургер-кнопка -->
            <button class="nav-tour__toggle" aria-label="Открыть меню">☰</button>

            <div class="nav-tour__logo-block">
                <a href="{% url 'home' %}">
                    <img src="/static/images/Lovi Moment logo.png" alt="Логотип" class="nav-tour__logo">
                </a>
            </div>

            <div class="nav-tour__menu" id="navMenu">
                <ul class="nav-tour__list">
                <li><a href="{% url 'about_us' %}">О нас</a></li>
                <li class="nav-tour__item nav-tour__dropdown">
                    <a href="{% url 'tour' %}" class="nav-tour__link">Туры</a>
                    <ul class="nav-tour__submenu">
                        <li><a href="{% url 'tour' %}">Кыргызстан</a></li>
                        <li><a href="{% url 'kz' %}">Казахстан</a></li>
                        <li><a href="{% url 'uz' %}">Узбекистан</a></li>
                    </ul>
                </li>
                <li><a href="{% url 'gallery' %}">Галерея</a></li>
                <li><a href="{% url 'blog' %}">Блог</a></li>
                <li><a href="{% url 'partners' %}">Партнерам</a></li>
                </ul>
            </div>

            <div class="nav-tour__action">
                <button class="nav-tour__btn">
                <a href="{% url 'sign_tour' %}">
                    Записаться на тур!
                </a>
                </button>
                <span class="nav-tour__lang">En</span>
            </div>
        </nav>

        <div class="header-tour-kg">
            <div class="tour-kyrg-butt">
                <div class="long-arrow">
                    <a href="{% url 'home' %}"><img src="/static/images/big-arrow.png" alt=""></a>
                </div>
                <div class="tour-gps">
                    <a href="{% url 'home' %}">Гланая</a><img src="/static/images/lil-arrow.png" alt="">
                    <a href="{% url 'tour' %}">Туры</a><img src="/static/images/lil-arrow.png" alt="">
                    <a href="{% url 'tour' %}">Кыргызстан</a><img src="/static/images/lil-arrow.png" alt="" style="visibility: hidden;">
                </div>

                <h1 class="big-kg">КЫРГЫЗСТАН</h1>

            </div>
            <div class="kg-text">
                <p>
                    Мы — ваша дверь в удивительный мир Кыргызстана и  Центральной Азии! <br>
Лови момент предлагает уникальные туры, которые позволят вам исследовать <br> захватывающие пейзажи и богатую культуру этого Кыргызстана.
                </p>
            </div>
            <div class="tour-down-arrow">
                <a href="#tury"><img src="/static/images/Vector 9.png" alt=""></a>
            </div>
        </div>
    </header>
    
    <section class="locations-section" id="tury">
        <div class="locations-container">
            <section class="big-gallery">
                <nav class="gallery-nav">
                    <ul class="gallery-nav__list">
                        <li class="gallery-nav__item">
                        <a href="{% url 'tour' %}" class="gallery-nav__link gallery-nav__link--active">Кыргызстан</a>
                        </li>
                        <li class="gallery-nav__item">
                        <a href="{% url 'uz' %}" class="gallery-nav__link">Узбекистан</a>
                        </li>
                        <li class="gallery-nav__item">
                        <a href="{% url 'kz' %}" class="gallery-nav__link">Казахстан</a>
                        </li>
                    </ul>
                </nav>
            </section>
            <!-- Контент будет загружен динамически -->
            <div id="toursContent">
                <!-- Секции туров будут добавлены здесь -->
            </div>
        </div>
    </section>
    
    <script>
    // Определяем текущую страну из URL или навигации
    function getCurrentCountry() {
        // Проверяем активную ссылку в навигации
        const activeLink = document.querySelector('.gallery-nav__link--active');
        if (activeLink) {
            const text = activeLink.textContent.trim();
            if (text === 'Кыргызстан') return 'Кыргызстан';
            if (text === 'Казахстан') return 'Казахстан';
            if (text === 'Узбекистан') return 'Узбекистан';
        }
        // По умолчанию Кыргызстан
        return 'Кыргызстан';
    }
    
    // Загрузка туров
    async function loadTours() {
        try {
            const response = await fetch('/api/tours');
            const tours = await response.json();
            console.log('Загружено туров:', tours.length);
            
            const currentCountry = getCurrentCountry();
            console.log('Текущая страна:', currentCountry);
            
            // Фильтруем туры по текущей стране и активности
            const filteredTours = tours.filter(tour => 
                tour.isActive && 
                tour.country === currentCountry
            );
            
            console.log('Отфильтровано туров для', currentCountry + ':', filteredTours.length);
            
            // Группируем туры по видам туров
            const toursByType = {};
            filteredTours.forEach(tour => {
                const tourTypeName = tour.tourType ? tour.tourType.name : 'Без категории';
                if (!toursByType[tourTypeName]) {
                    toursByType[tourTypeName] = [];
                }
                toursByType[tourTypeName].push(tour);
            });
            
            console.log('Туры по видам:', toursByType);
            
            // Отображаем туры
            displayTours(toursByType);
            
        } catch (error) {
            console.error('Ошибка при загрузке туров:', error);
        }
    }
    
    // Отображение туров
    function displayTours(toursByType) {
        const container = document.getElementById('toursContent');
        if (!container) {
            console.error('Контейнер toursContent не найден');
            return;
        }
        
        container.innerHTML = '';
        
        // Сортируем виды туров (Индивидуальные, Групповые, Корпоративные и т.д.)
        const sortedTypes = Object.keys(toursByType).sort((a, b) => {
            const order = ['Индивидуальные туры', 'Групповые туры', 'Корпоративные туры'];
            const indexA = order.indexOf(a);
            const indexB = order.indexOf(b);
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA !== -1) return -1;
            if (indexB !== -1) return 1;
            return a.localeCompare(b);
        });
        
        sortedTypes.forEach(tourTypeName => {
            const tours = toursByType[tourTypeName];
            
            // Создаем секцию для вида тура
            const section = document.createElement('div');
            section.className = 'tour-type-section';
            
            // Заголовок
            const titleWrapper = document.createElement('div');
            titleWrapper.className = 'locations-title-wrapper';
            const title = document.createElement('h2');
            title.className = 'locations-title';
            title.textContent = tourTypeName;
            titleWrapper.appendChild(title);
            section.appendChild(titleWrapper);
            
            // Сетка карточек
            const grid = document.createElement('div');
            grid.className = 'locations-grid';
            
            tours.forEach(tour => {
                const card = document.createElement('a');
                card.href = `/tour-about/${tour.slug || tour.id}`;
                card.className = 'location-item';
                
                // Изображение
                const img = document.createElement('img');
                img.src = tour.headerImage || tour.images?.[0]?.imagePath || '/static/images/location.png';
                img.alt = tour.title || 'Тур';
                card.appendChild(img);
                
                // Название
                const title = document.createElement('p');
                title.textContent = tour.title || 'Тур';
                card.appendChild(title);
                
                grid.appendChild(card);
            });
            
            section.appendChild(grid);
            container.appendChild(section);
        });
        
        // Если нет туров, показываем сообщение
        if (sortedTypes.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Туры для этой страны пока не добавлены</p></div>';
        }
    }
    
    // Загружаем туры при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadTours();
        
        // Обновляем туры при переключении страны
        const countryLinks = document.querySelectorAll('.gallery-nav__link');
        countryLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Убираем активный класс со всех ссылок
                countryLinks.forEach(l => l.classList.remove('gallery-nav__link--active'));
                
                // Добавляем активный класс к текущей ссылке
                link.classList.add('gallery-nav__link--active');
                
                // Обновляем заголовок страницы
                const countryName = link.textContent.trim();
                const bigTitle = document.querySelector('.big-kg');
                if (bigTitle) {
                    bigTitle.textContent = countryName.toUpperCase();
                }
                
                // Обновляем хлебные крошки
                const breadcrumb = document.querySelector('.tour-gps');
                if (breadcrumb) {
                    const links = breadcrumb.querySelectorAll('a');
                    if (links.length >= 3) {
                        links[2].textContent = countryName;
                    }
                }
                
                // Перезагружаем туры
                loadTours();
            });
        });
    });
    </script>
    
<footer class="footer">
            <div class="footer-inner">
                <div class="footer-col logo-col">
                    <img src="{% static 'images/Lovi Moment logo-1.png' %}" alt="Lovi Moment Travel" class="footer-logo" />
                </div>

                <div class="footer-col">
                    <h4>Главная</h4>
                    <ul>
                        <li><a href="{% url 'about_us' %}">О нас</a></li>
                        <li><a href="{% url 'blog' %}">Блог о Кыргызстане</a></li>
                        <li><a href="{% url 'corp_tour' %}">Корпоративные туры</a></li>
                        <li><a href="{% url 'indi_tour' %}">Индивидуальные туры</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                <h4>Туры</h4>
                    <ul>
                        <li><a href="{% url 'tour' %}">Кыргызстан</a></li>
                        <li><a href="{% url 'kz' %}">Казахстан</a></li>
                        <li><a href="{% url 'uz' %}">Узбекистан</a></li>
                    </ul>
                </div>

                <div class="footer-col">
                    <h4>По другим вопросам</h4>
                    <p>+996 503 904 904 </p>
                    <p>+996 705 904 904 </p>
                    <p>+996 508 904 904 </p>
                    <p>+996 505 904 904 </p>
                    <button class="footer-btn"><a href="{% url 'sign_tour' %}">Записаться на тур! </a></button>
                </div>

                <div class="footer-col address">
                    <h4>Адрес</h4>
                    <p>ул. Калык Акиева 66,<br> ТЦ Весна, 3 этаж  С13А</p>
                    <p><a  class="wattspp" href="https://wa.me/996505904904"><img src="/static/images/free-icon-logo-15713434.png" alt="" style="width: 32px; height: 32px;">996 505 904 904</a></p>

                    <p ><a class="instS" href="https://www.instagram.com/lovimoment_travel/"><img src="" alt=""><img src="/static/images/inst.png" alt="">@lovimoment_travel</a></p>
                </div>
            </div>
        </footer>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const toggle = document.querySelector('.nav-tour__toggle');
                const menu   = document.getElementById('navMenu');

                toggle.addEventListener('click', () => {
                menu.classList.toggle('open');
                });

                // Закрытие по клику вне меню
                document.addEventListener('click', e => {
                if (!e.target.closest('.nav-tour')) {
                    menu.classList.remove('open');
                }
                });
            });
        </script>
        <script>
            // Загрузка декоративного фона (ornament)
            async function loadOrnamentBackground() {
              try {
                const apiUrl = '/api/ornament-background?t=' + Date.now() + '&r=' + Math.random();
                const response = await fetch(apiUrl, { cache: 'no-store' });
                const data = await response.json();
                
                if (!data || !data.path) {
                  updateOrnamentBackground('/static/images/ornament.png');
                  return;
                }
                
                const timestamp = Date.now();
                const ornamentUrl = data.path + (data.path.includes('?') ? '&' : '?') + 't=' + timestamp + '&r=' + Math.random();
                updateOrnamentBackground(ornamentUrl);
              } catch (error) {
                console.error('Ошибка при загрузке декоративного фона:', error);
                updateOrnamentBackground('/static/images/ornament.png');
              }
            }

            function updateOrnamentBackground(imagePath) {
              const style = document.createElement('style');
              style.id = 'ornament-background-style';
              
              const oldStyle = document.getElementById('ornament-background-style');
              if (oldStyle) oldStyle.remove();
              
              style.textContent = `
                html body::before {
                  background-image: url('${imagePath}') !important;
                  background-repeat: repeat !important;
                  background-size: var(--ornament-size) auto !important;
                  background-position: 0 0 !important;
                }
              `;
              
              document.head.appendChild(style);
            }

            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', () => {
                loadOrnamentBackground();
                setInterval(loadOrnamentBackground, 30000);
              });
            } else {
              loadOrnamentBackground();
              setInterval(loadOrnamentBackground, 30000);
            }
        </script>

</body>
</html>
